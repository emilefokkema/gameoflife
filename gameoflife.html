<html>
<head>
	<style>
		body{overflow: hidden;}
		.snapshots{
			position: absolute;
			right: 0px;
			top:0px;
			width:20px;
			height: 100%;
			background-color: rgba(0,0,0,0.5);
			overflow-y: hidden;
			overflow-x:hidden;
		}
		.snapshots:hover{
			width:150px;
			overflow-y: scroll;
			padding-left: 10px;
			padding-right: 20px;
		}
		.snapshot {
			width:150px;
			height: 150px;
			background-color: #fff;
			margin-top:10px;
			display: none;
			position: relative;
		}
		.snapshot:hover .snapshot-layover{
			display: block;
		}
		.snapshot-option{
			width: 73px;
			height: 30px;
			display: inline-block;
			margin: 0px;
			cursor: pointer;
			background-color: #fff;
			font-size: 10px;
			font-family: Verdana;
			color: #000;
			border: 1pt solid #000;
		}
		.snapshot-option:hover{
			background-color: #aaa;
		}
		.snapshot-layover{
			display: none;
			background-color: rgba(255,255,255,0.5);
			position: absolute;
			left: 0px;
			top:0px;
			width: 100%;
			height: 100%;
		}
		.snapshots:hover .snapshot{
			display: block;
		}
		.step-count {
			position: absolute;
			top:10px;
			left:10px;
			color:#000;
			font-family: monospace;
			font-size: 20px;
		}
		.menu{
			position:absolute;
			display:none;
			width:150px;
			background-color: #fff;
			min-height: 30px;
			border: 1pt solid #000;
		}
		.option{
			height: 30px;
			padding:3px;
			font-family: Arial;
			cursor: pointer;
		}
		.option:hover{
			background-color:#ccc;
		}
		.input {
			position: fixed;
			left:50%;
			top:50%;
			width:400px;
			height: 300px;
			background-color: #ddd;
			transform: translate(-50%,-50%);
		}
		.input textarea{
			position: absolute;
			left:0px;
			top:0px;
			width: 100%;
			height: 80%;
		}
		.input input[type="button"]{
			position: absolute;
			bottom: 0px;
		}
	</style>
</head>
<body style="padding:0px;margin:0px"></body>
<script src="quadtree.js"></script>
<script>
(function(){
	
	var w = document.body.offsetWidth,
		h = document.body.offsetHeight,
		size, nx, ny,
		setSize = function(s){
			size = s;
			nx = Math.ceil(w / size);
			ny = Math.ceil(h / size);
		},
		zoom = function(factor){
			var centerLocation = mousePositionToPositionLocation(w/2, h/2);
			var newSize;
			if(factor < 1){
				newSize = Math.max(1, Math.floor(size * factor));
			}else{
				newSize = size * factor;
			}
			setSize(newSize);
			xShift = Math.floor(w/(2 * size) - centerLocation.x);
			yShift = Math.floor(h/(2 * size) - centerLocation.y);
		},
		xShift = 0,
		yShift = 0,
		c = (function(){
			var canvas = document.createElement("canvas");
			canvas.setAttribute("width", w);
			canvas.setAttribute("height", h);
			document.body.appendChild(canvas);
			var context = canvas.getContext("2d");
			var initializeContext = function(){
				context.strokeStyle = '#000';
				context.lineWidth = 0.1;
				context.fillStyle = '#000';
			};
			initializeContext();
			canvas.addEventListener('click',function(e){
				if(e.shiftKey){
					var loc = mousePositionToPositionLocation(e.clientX, e.clientY);
					selection.select(loc.x, loc.y);
					drawAll();
					return;
				}
				menu.hide();
				selection.clear();
				var p = mousePositionToPosition(e.clientX, e.clientY);
				
				if(p.isOccupied()){
					p.vacate();
				}else{
					p.occupy();
				}
				drawAll();
			});
			canvas.addEventListener('contextmenu',function(e){
				e.preventDefault();
				menu.show(e.clientX, e.clientY);
				return false;
			});
			return {
				context:context,
				clear:function(){canvas.width = w;initializeContext();}
			};
		})(),
		menu = (function(){
			var currentX, currentY;
			var div = document.createElement("div");
			div.setAttribute("class","menu");
			document.body.appendChild(div);
			var addOption = function(text, f){
				var option = document.createElement('div');
				option.setAttribute("class","option");
				option.appendChild(document.createTextNode(text));
				option.addEventListener('click', function(){
					hide();
					f(currentX, currentY);
				});
				div.appendChild(option);
				return function(){div.removeChild(option);}
			};
			var show = function(x,y){
				var loc = mousePositionToPositionLocation(x,y);
				currentX = loc.x;
				currentY = loc.y;
				div.style.display = "initial";
				div.style.left = x + "px";
				div.style.top = y + "px";
			};
			var hide = function(){div.style.display = "none"};
			return {
				addOption:addOption,
				show:show,
				hide:hide
			}
		})(),
		selection = (function(){
			var present = false, removeMenuOption = null, minX, minY, maxX, maxY;
			var getPositions = function(){
				return position.getAllInBox({
							minX:minX,
							maxX:maxX,
							minY:minY,
							maxY:maxY
						});
			};
			var copyPositions = function(positions){
				clipboard.copy(positions.map(function(p){return {
						x: p.x - minX,
						y: p.y - minY
					};}), true);
			};
			var addMenuOptions = function(){
				var remove = [];
				remove.push(menu.addOption('make RLE',
					function(){
						alert(makeRLE(getPositions()));
					}));
				remove.push(menu.addOption('copy',function(x,y){
					var positions = getPositions();
					copyPositions(positions);
					clear();
					drawAll();
				}));
				remove.push(menu.addOption('cut',function(){
					var positions = getPositions();
					copyPositions(positions);
					positions.map(function(p){p.vacate();});
					clear();
					drawAll();
				}));
				remove.push(menu.addOption('alive', function(){
					for(var x=minX;x<=maxX;x++){
						for(var y=minY;y<=maxY;y++){
							position(x,y).occupy();
						}
					}
					clear();
					drawAll();
				}));
				remove.push(menu.addOption('dead', function(){
					getPositions().map(function(p){p.vacate();});
					clear();
					drawAll();
				}));
				remove.push(menu.addOption('random', function(){
					for(var x=minX;x<=maxX;x++){
						for(var y=minY;y<=maxY;y++){
							if(Math.random()<0.5){
								position(x,y).occupy();
							}
						}
					}
					clear();
					drawAll();
				}));
				return function(){
					remove.map(function(f){f();});
					remove = [];
				};
			};
			var select = function(x,y){
				if(!present){
					minX = maxX = x;
					minY = maxY = y;
					present = true;
				}else{
					if(x > minX){
						maxX = x;
					}else{
						maxX = minX;
						minX = x;
					}
					if(y > minY){
						maxY = y;
					}else{
						maxY = minY;
						minY = y;
					}
				}
				!removeMenuOption && (removeMenuOption = addMenuOptions());
			};
			var draw = function(){
				if(!present){return;}
				var style = context.strokeStyle;
				var lineWidth = context.lineWidth;
				context.strokeStyle = '#00f';
				context.lineWidth = 2;
				var minLoc = positionToMousePosition({x:minX,y:minY});
				var maxLoc = positionToMousePosition({x:maxX + 1,y:maxY + 1});
				context.strokeRect(minLoc.x, minLoc.y, maxLoc.x - minLoc.x, maxLoc.y - minLoc.y);
				context.strokeStyle = style;
				context.lineWidth = lineWidth;
			};
			var clear = function(){
				present = false;
				removeMenuOption && removeMenuOption();
				removeMenuOption = null;
			};
			return {
				select:select,
				draw:draw,
				clear:clear
			};
		})(),
		input = (function(){
			var open = false;
			var div = document.createElement('div');
			div.setAttribute("class","input");
			var text = document.createElement('textarea');
			var button = document.createElement('input');
			button.setAttribute('type','button');
			button.setAttribute('value','OK');
			div.appendChild(text);
			div.appendChild(button);
			var show = function(initialText){
				open = true;
				div.style.display = 'initial';
				if(initialText){
					text.value = initialText;
				}
			};
			var hide = function(){
				open = false;
				div.style.display = 'none';
			};
			var handler = function(v){};
			document.body.appendChild(div);
			button.addEventListener('click',function(){
				handler(text.value);
			});
			hide();
			var f = function(resultHandler, initialText){
				show(initialText);
				handler = function(v){
					hide();
					resultHandler(v);
				};
			};
			f.isOpen = function(){return open;};
			return f;
		})(),
		alert = function(text){
			input(function(){
				clear();
				drawAll();
			},text);
		},
		clipboard = (function(){
			var relativePositions, removeMenuOption;
			var paste = function(x, y){
				relativePositions.map(function(p){
					position(x + p.x,y + p.y).occupy();
				});
				drawAll();
			};
			var copy = function(_relativePositions, makeSnapshot){
				relativePositions = _relativePositions;
				!removeMenuOption && (removeMenuOption = menu.addOption('paste', paste));
				if(makeSnapshot){
					snapshots.add(_relativePositions);
				}
			};
			
			return {copy:copy};
		})(),
		context = c.context,
		clear = c.clear,
		fillRect = function(screenX, screenY){
			context.fillRect(screenX, screenY, size, size);
		},
		drawVerticalLine = function(x){
			context.beginPath();
			context.moveTo(x,0);
			context.lineTo(x,h);
			context.stroke();
		},
		mousePositionToPositionLocation = function(mX,mY){
			return {
				x:Math.floor(mX / size) - xShift,
				y:Math.floor(mY / size) - yShift
			};
		},
		mousePositionToPosition = function(mX, mY){
			var positionLocation = mousePositionToPositionLocation(mX,mY);
			return position(positionLocation.x,positionLocation.y);
		},
		positionToMousePosition = function(p){
			return {
				x:(p.x + xShift) * size,
				y:(p.y + yShift) * size
			};
		},
		position = quadTreePositionFactory(positionToMousePosition, fillRect),
		snapshots = (function(){
			var snapshotWidth = 150, snapshotHeight = 150;
			var makeSnapshot = function(positions, forget){
				var minX = Math.min.apply(null, positions.map(function(p){return p.x;})),
					maxX = Math.max.apply(null, positions.map(function(p){return p.x;})),
					minY = Math.min.apply(null, positions.map(function(p){return p.y;})),
					maxY = Math.max.apply(null, positions.map(function(p){return p.y;})),
				positions = positions.map(function(p){
					return {x:p.x-minX,y:p.y-minY};
				});
				var draw = function(ctx){
					var cellSize = Math.min(snapshotWidth / (maxX - minX + 1), snapshotHeight / (maxY - minY + 1));
					positions.map(function(p){
						ctx.fillRect(p.x * cellSize, p.y * cellSize, cellSize, cellSize);
					});
				};
				var restore = function(){
					position.vacateAll();
					stepCount = 0;
					setCounter();
					positions.map(function(p){
						position(p.x,p.y).occupy();
					});
					drawAll();
				};
				var copyToClipboard = function(){
					clipboard.copy(positions);
				};
				return {
					draw:draw,
					restore:restore,
					forget:forget,
					copyToClipboard:copyToClipboard
				};
			};
			var container = document.createElement('div');
			container.setAttribute('class','snapshots');
			document.body.appendChild(container);
			var addSnapshotOption = function(layover, name, toDo){
				var option = document.createElement('div');
				option.setAttribute('class','snapshot-option');
				option.appendChild(document.createTextNode(name));
				option.addEventListener('click',toDo);
				layover.appendChild(option);
			};
			var add = function(positions){
				var s = document.createElement('div');
				s.setAttribute('class','snapshot');
				container.appendChild(s);
				var canvas = document.createElement('canvas');
				canvas.setAttribute('width',snapshotWidth);
				canvas.setAttribute('height',snapshotHeight);
				s.appendChild(canvas);
				var newSnapshot = makeSnapshot(positions, function(){
					container.removeChild(s);
				});
				var context = canvas.getContext("2d");
				context.fillStyle = '#000';
				newSnapshot.draw(context);
				var layover = document.createElement('div');
				layover.setAttribute('class','snapshot-layover');
				s.appendChild(layover);
				addSnapshotOption(layover, 'restore',function(){
					newSnapshot.restore();
				});
				addSnapshotOption(layover, 'copy',function(){
					newSnapshot.copyToClipboard();
				});
				addSnapshotOption(layover, 'delete',function(){
					newSnapshot.forget();
				});
				addSnapshotOption(layover, 'RLE',function(){
					alert(makeRLE(positions));
				});
			};
			return {
				add:add
			};
		})(),
		drawHorizontalLine = function(y){
			context.beginPath();
			context.moveTo(0,y);
			context.lineTo(w,y);
			context.stroke();
		},
		stepCount = 0,
		doStep = function(stop){
			try{
				var diagnosis = position.getDiagnosis();
				var positionsToVacate = diagnosis.positionsToVacate;
				var positionsToOccupy = diagnosis.positionsToOccupy;
				if(positionsToVacate.length == 0 && positionsToOccupy.length == 0){
					stop && stop();
				}
				for(var i=0;i<positionsToVacate.length;i++){
					positionsToVacate[i].vacate();
				}
				positionsToOccupy.map(function(p){position(p.x,p.y).occupy();});
				stepCount++;
			}catch(e){
				stop && stop();
				throw e;

			}
		},
		going = false,
		drawingInterval,
		setCounterInterval,
		setCounter = (function(){
			var a = document.createElement('a');
			a.setAttribute('class','step-count');
			document.body.appendChild(a);
			return function(){
				a.innerHTML = stepCount;
			};
		})(),
		stop = function(){
			going = false;
			window.clearInterval(drawingInterval);
			window.clearInterval(setCounterInterval);
			setCounter();
		},
		go = function(onStop){
			var sstop = function(){
				stop();
				onStop && onStop();
			};
			going = true;
			drawingInterval = window.setInterval(function(){
				doStep(sstop);
				drawAll();
			},50);
			setCounterInterval = window.setInterval(setCounter, 250);
		},
		parseRLEBody = function(body, occupy){
			var parts = body.replace(/\s*/g,"").match(/\d*[bo\$]/g);
			var x = 0, y = 0;
			parts.map(function(p){
				var match = p.match(/^(\d*)([bo\$])$/);
				var number = match[1] ? parseInt(match[1]) : 1;
				for(var i=0;i<number;i++){
					if(match[2] == "$"){
						x = 0;
						y++;
					}else{
						if(match[2] == "o"){
							occupy(x,y);
						}
						x++;
					} 
				}
			});
		},
		makeRLE = function(positions){
			var lines = [];
			var getLineForY = function(y){
				var result = null;
				for(var i=0;i<lines.length;i++){
					if(lines[i].y == y){
						result = lines[i];
					}
				}
				return result;
			};
			var findLineForPosition = function(p){
				var result = getLineForY(p.y);
				if(!result){
					result = {y:p.y,positions:[]};
					lines.push(result);
				}
				return result;
			};
			positions.map(function(p){
				findLineForPosition(p).positions.push(p.x);
			});
			lines.sort(function(l1,l2){return l1.y - l2.y;});
			var ys = lines.map(function(l){return l.y;});
			var minY = Math.min.apply(null, ys);
			var maxY = Math.max.apply(null, ys);
			var lineMinX = function(l){return Math.min.apply(null, l.positions);};
			var lineMaxX = function(l){return Math.max.apply(null, l.positions);};
			var minX = Math.min.apply(null, lines.map(lineMinX));
			var maxX = Math.max.apply(null, lines.map(lineMaxX));
			var result = (function(){
				var kind = {ALIVE:0,DEAD:1,NEWLINE:2};
				var symbol = [];
				symbol[kind.ALIVE] = "o";
				symbol[kind.DEAD] = "b";
				symbol[kind.NEWLINE] = "$";
				var currentKind = -1;
				var all = [];
				var latest = null;
				var pushKind = function(k){
					if(k != currentKind){
						latest = {kind:k,count:0};
						all.push(latest);
					}
					currentKind = k;
					latest.count++;
				};
				var toString = function(){
					return all.map(function(k){return ""+(k.count > 1 ? k.count : "")+symbol[k.kind];}).join("");
				};
				return {
					alive:function(){pushKind(kind.ALIVE);},
					dead:function(){pushKind(kind.DEAD);},
					newLine:function(){pushKind(kind.NEWLINE);},
					toString:toString
				};
			})();

			for(var y=minY;y<=maxY;y++){
				var line = getLineForY(y);
				if(line){
					for(var x=minX;x<=maxX;x++){
						if(line.positions.indexOf(x) > -1){
							result.alive();
						}else{
							result.dead();
						}
					}
				}
				result.newLine();
			}
			return result.toString();
		},
		readHash = function(){
			var hash = window.location.hash;
			if(!hash){
				return;
			}
			parseRLEBody(hash.substr(1), function(x,y){
				position(x,y).occupy()
			});
		},
		drawAll = function(){
			clear();
			for(var i = 0;i<nx;i++){
				drawVerticalLine(i * size);
			}
			for(var i = 0;i<ny;i++){
				drawHorizontalLine(i * size);
			}
			selection.draw();
			position.draw();
		};
	menu.addOption('parse RLE',function(x,y){
		input(function(v){
			if(!v){return;}
			position.vacateAll();
			parseRLEBody(v, function(xx,yy){position(xx+x,yy+y).occupy();});
			drawAll();
		});
	});
	setSize(15);
	readHash();
	drawAll();
	setCounter();
	window.go = go;
	var zoomOut = function(){clear();zoom(0.5);drawAll();};
	var zoomIn = function(){clear();zoom(2);drawAll();};
	var left = function(){xShift += Math.floor(nx/4);drawAll();};
	var right = function(){xShift -= Math.floor(nx/4);drawAll();};
	var up = function(){yShift += Math.floor(ny/4);drawAll();};
	var down = function(){yShift -= Math.floor(ny/4);drawAll();};
	window.getStepCount = function(){return stepCount;};
	window.resetStepCount = function(){stepCount = 0;}
	window.health = function(){
		var all = position.countAll();
		var alive = position.countAlive();
		var treeSize = position.getCurrentTreeSize();
		return {
			all:all,
			alive:alive,
			ratio:all/alive,
			treeSize: treeSize
		};
	};
	window.alive = function(x,y){position(x,y).occupy();};
	window.parseRLEBody = function(body){
		position.vacateAll();
		parseRLEBody(body, function(x,y){position(x,y).occupy();});
		drawAll();
	};
	window.copyFromRLE = function(body){
		var relativePositions = [];
		parseRLEBody(body, function(x,y){
			relativePositions.push({x:x,y:y});
		});
		clipboard.copy(relativePositions);
	};
	window.addEventListener("keydown",function(e){
		if(input.isOpen()){return true;}
		if(e.key == "+"){
			zoomIn();
		}
		if(e.key == "-"){
			zoomOut();
		}
		if(e.key == "ArrowLeft"){
			left();
		}
		if(e.key == "ArrowRight"){
			right();
		}
		if(e.key == "ArrowUp"){
			up();
		}
		if(e.key == "ArrowDown"){
			down();
		}
		if(e.key == " "){
			if(going){
				stop();
			}else{
				go();
			}
		}
		if(e.key == "c"){
			position.vacateAll();
			stepCount = 0;
			setCounter();
			drawAll();
		}
		if(e.key == "s"){
			doStep();
			drawAll();
			setCounter();
		}
		if(e.key == "r"){
			snapshots.add(position.getAllAlive());
		}
	});
})();
</script>
</html>